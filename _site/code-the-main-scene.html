<h1 id="main">Main</h1>

<p>This is where it all comes together. Up until now your experience has largely been that of using the editor and writing code. Now we get to play the game. You’ll likely catch something you’ve forgotten here.</p>

<p>Take a moment and try to do it without any guidance. But you will hit things you have not done. Here is the <a href="https://docs.godotengine.org/en/stable/getting_started/first_2d_game/05.the_main_game_scene.html">GDScript Ref</a></p>

<p><img src="https://images.pexels.com/photos/2835623/pexels-photo-2835623.jpeg?auto=compress&amp;cs=tinysrgb&amp;w=1260&amp;h=750&amp;dpr=1" alt="cat" /></p>

<h1 id="implementing">Implementing</h1>
<h2 id="high-level-structure">High level structure</h2>
<h6 id="filesrcmain_sceners">file:../src/main_scene.rs</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;&lt;</span><span class="n">imports</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="k">struct</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="k">struct</span> <span class="k">impl</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">class</span> <span class="k">impl</span><span class="o">&gt;&gt;</span>

</code></pre></div></div>
<h2 id="imports">Imports</h2>
<h6 id="imports-1">imports</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">godot</span><span class="p">::</span><span class="nn">engine</span><span class="p">::{</span><span class="n">AudioStreamPlayer2D</span><span class="p">,</span> <span class="n">Marker2D</span><span class="p">,</span> <span class="n">PathFollow2D</span><span class="p">,</span> <span class="n">RigidBody2D</span><span class="p">,</span> <span class="n">Timer</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">godot</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">rand</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">f32</span><span class="p">::</span><span class="nn">consts</span><span class="p">::</span><span class="n">PI</span><span class="p">;</span>

<span class="k">use</span> <span class="k">crate</span><span class="p">::</span><span class="nn">hud</span><span class="p">::</span><span class="n">Hud</span><span class="p">;</span>
<span class="k">use</span> <span class="k">crate</span><span class="p">::</span><span class="nn">mob</span><span class="p">::</span><span class="n">Mob</span><span class="p">;</span>
<span class="k">use</span> <span class="k">crate</span><span class="p">::</span><span class="nn">player</span><span class="p">::</span><span class="n">Player</span><span class="p">;</span>
</code></pre></div></div>
<p>We have a couple new things. We pull in the other file’s structs so that we can use the types within.</p>

<h2 id="the-struct">The Struct</h2>
<p>Here’s where things are going to get different.</p>

<p>In the official tutorial they call out a packed scene. We handle that here and in the ready. Lets dive in.</p>

<h6 id="struct">struct</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(GodotClass)]</span>
<span class="nd">#[class(base=Node)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">MainScene</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">score</span><span class="p">:</span> <span class="n">real</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">mob_scene</span><span class="p">:</span> <span class="n">Gd</span><span class="o">&lt;</span><span class="n">PackedScene</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="nd">#[base]</span>
    <span class="k">pub</span> <span class="n">base</span><span class="p">:</span> <span class="n">Base</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Everything outside of the <code class="language-plaintext highlighter-rouge">PackedScene</code> is typical. However we do have a <code class="language-plaintext highlighter-rouge">Gd&lt;T&gt;</code>. This is a very important type in gdext. So important in fact that it is on <a href="https://godot-rust.github.io/docs/gdext/master/godot/#type-categories">the first page</a> of the gdext docs. Please refer to the documentation <a href="https://godot-rust.github.io/docs/gdext/master/godot/obj/struct.Gd.html">here</a> to learn more</p>

<h2 id="inode">INode</h2>
<p>This is the next easiest part of this code. It has one new function and it’s just like the <code class="language-plaintext highlighter-rouge">player</code> code in how we use it.</p>
<h6 id="class-impl">class impl</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[godot_api]</span>
<span class="k">impl</span> <span class="n">INode</span> <span class="k">for</span> <span class="n">MainScene</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="n">Base</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">MainScene</span> <span class="p">{</span>
            <span class="n">base</span><span class="p">,</span>
            <span class="n">score</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">mob_scene</span><span class="p">:</span> <span class="nn">PackedScene</span><span class="p">::</span><span class="nf">new</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">ready</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.mob_scene</span> <span class="o">=</span> <span class="nf">load</span><span class="p">(</span><span class="s">"res://mob.tscn"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>As you can see we instantiate the PackedScene as a new empty, like we did the with <code class="language-plaintext highlighter-rouge">Player.screen_size</code>. Then we assign a value to it with <code class="language-plaintext highlighter-rouge">load</code> in the <code class="language-plaintext highlighter-rouge">ready</code> call. This is once again because lifecycles. But you could also argue its because <a href="https://godot-rust.github.io/docs/gdext/master/godot/engine/fn.load.html"><code class="language-plaintext highlighter-rouge">load()</code> might fail</a>. In rust when you use the struct syntax that we chose in <code class="language-plaintext highlighter-rouge">init</code> it by convention should not be failable. If it’s failable you should use <code class="language-plaintext highlighter-rouge">builder</code> semantics and provide a <code class="language-plaintext highlighter-rouge">Result&lt;T, E&gt;</code> value instead. We would be violating that if <code class="language-plaintext highlighter-rouge">load</code> failed.</p>

<h1 id="the-main-event">The Main Event</h1>
<p>This is where things start to go in direction’s you’ll find challenging. Lets start with the easy parts.</p>

<h6 id="struct-impl">struct impl</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[godot_api]</span>
<span class="k">impl</span> <span class="n">MainScene</span> <span class="p">{</span>
<span class="o">&lt;&lt;</span><span class="n">game</span> <span class="n">over</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">new</span> <span class="n">game</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">score</span> <span class="n">timer</span> <span class="n">timeout</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">start</span> <span class="n">timer</span> <span class="n">timeout</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">mob</span> <span class="n">timer</span> <span class="n">timeout</span><span class="o">&gt;&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <a href="https://docs.godotengine.org/en/stable/getting_started/first_2d_game/05.the_main_game_scene.html#main-script">GDScript Tutorial</a> had you code timeout functions. They are very similar in rust land.</p>
<h2 id="easy-timeouts">Easy Timeouts</h2>
<h6 id="start-timer-timeout">start timer timeout</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">#[func]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">on_start_timer_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">score_timer</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"ScoreTimer"</span><span class="p">);</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">mob_timer</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"MobTimer"</span><span class="p">);</span>
        <span class="n">score_timer</span><span class="nf">.start</span><span class="p">();</span>
        <span class="n">mob_timer</span><span class="nf">.start</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>Look at that. This isn’t hard.</p>

<h6 id="score-timer-timeout">score timer timeout</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">#[func]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">on_score_timer_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.score</span> <span class="o">+=</span> <span class="mf">1.0</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">hud</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Hud</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"HUD"</span><span class="p">);</span>
        <span class="n">hud</span><span class="nf">.bind_mut</span><span class="p">()</span><span class="nf">.update_score</span><span class="p">(</span><span class="k">self</span><span class="py">.score</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>The gotcha here is <code class="language-plaintext highlighter-rouge">bind_mut</code>. Its because the hud is another rust component. To gain access we use bind. Because we are performing a modifying call we have to <code class="language-plaintext highlighter-rouge">bind_mut()</code></p>

<h1 id="new-game">New Game</h1>
<p>This is a lot of things you chould be okay with doing. There’s the same <code class="language-plaintext highlighter-rouge">bind_mut()</code> gotcha. But once you’re past that its the same game</p>
<h6 id="new-game-1">new game</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">#[func]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new_game</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.score</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">player</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Player</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Player"</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">marker</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Marker2D</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"StartPosition"</span><span class="p">);</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">player</span> <span class="o">=</span> <span class="n">player</span><span class="nf">.bind_mut</span><span class="p">();</span>
        <span class="n">player</span><span class="nf">.start</span><span class="p">(</span><span class="n">marker</span><span class="nf">.get_global_position</span><span class="p">());</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">start_timer</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"StartTimer"</span><span class="p">);</span>
        <span class="n">start_timer</span><span class="nf">.start</span><span class="p">();</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">hud</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Hud</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"HUD"</span><span class="p">);</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">hud</span> <span class="o">=</span> <span class="n">hud</span><span class="nf">.bind_mut</span><span class="p">();</span>
        <span class="n">hud</span><span class="nf">.update_score</span><span class="p">(</span><span class="k">self</span><span class="py">.score</span><span class="p">);</span>
        <span class="n">hud</span><span class="nf">.show_message_text</span><span class="p">(</span><span class="s">"Get Ready"</span><span class="nf">.into</span><span class="p">());</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">music_player</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">AudioStreamPlayer2D</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Music"</span><span class="p">);</span>
        <span class="n">music_player</span><span class="nf">.play</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>We’ve got the music player calls, the hud calls, a show message call. But at the end of the day this is just <code class="language-plaintext highlighter-rouge">get_node_as</code> with a couple instances of <code class="language-plaintext highlighter-rouge">bind_mut()</code></p>

<p>Good job if you got this one. No worries if you didn’t. <code class="language-plaintext highlighter-rouge">bind_mut</code> is a curve ball.</p>

<h1 id="the-hard-timeout">The Hard Timeout</h1>
<p>This is the hardest part. Of the entire application. Every line of code. This right here is the hardest. If you didn’t get it no worries. If you did congrats. I know I didn’t.</p>

<h6 id="mob-timer-timeout">mob timer timeout</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">#[func]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">on_mob_timer_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
<span class="o">&lt;&lt;</span><span class="n">instantiate</span> <span class="k">as</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">pick</span> <span class="n">location</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">set</span> <span class="n">rotation</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">add</span> <span class="n">child</span><span class="o">&gt;&gt;</span>

<span class="o">&lt;&lt;</span><span class="n">make</span> <span class="n">the</span> <span class="n">mob</span> <span class="n">go</span><span class="o">&gt;&gt;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Lets talk about why its hard before we get into it.</p>

<p>We have a somewhat solvable problem of picking the location on the path. That’s something you could pretty easily get. At the same time. Its using ranges and RNG as well as setting progress.</p>
<h6 id="pick-location">pick location</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">let</span> <span class="k">mut</span> <span class="n">mob_spawn_location</span> <span class="o">=</span> <span class="k">self</span>
            <span class="py">.base</span>
            <span class="py">.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">PathFollow2D</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"MobPath/MobSpawnLocation"</span><span class="p">);</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">rng</span> <span class="o">=</span> <span class="nn">rand</span><span class="p">::</span><span class="nf">thread_rng</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">progress</span> <span class="o">=</span> <span class="n">rng</span><span class="nf">.gen_range</span><span class="p">(</span><span class="nn">u32</span><span class="p">::</span><span class="n">MIN</span><span class="o">..</span><span class="nn">u32</span><span class="p">::</span><span class="n">MAX</span><span class="p">);</span>

        <span class="n">mob_spawn_location</span><span class="nf">.set_progress</span><span class="p">(</span><span class="n">progress</span> <span class="k">as</span> <span class="nb">f32</span><span class="p">);</span>
        <span class="n">mob_scene</span><span class="nf">.set_position</span><span class="p">(</span><span class="n">mob_spawn_location</span><span class="nf">.get_position</span><span class="p">());</span>
</code></pre></div></div>

<p>But you may not have even hit this problem because</p>

<h6 id="instantiate-as">instantiate as</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">let</span> <span class="k">mut</span> <span class="n">mob_scene</span> <span class="o">=</span> <span class="k">self</span><span class="py">.mob_scene.instantiate_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">RigidBody2D</span><span class="o">&gt;</span><span class="p">();</span>
</code></pre></div></div>

<p>To even see this part of the problem you need to crack <code class="language-plaintext highlighter-rouge">instantiate_as</code>. You’ve never used it before. Its the only time we use it in this project. We use this because we are turning a scene into a node. <code class="language-plaintext highlighter-rouge">instantiate_as::&lt;T&gt;()</code> takes a <code class="language-plaintext highlighter-rouge">PackedScene</code> and returns a <code class="language-plaintext highlighter-rouge">Gd&lt;T&gt;</code> (I told you <code class="language-plaintext highlighter-rouge">Gd&lt;&gt;</code> was important). But this function is failable. This will panic and crash if it can’t become <code class="language-plaintext highlighter-rouge">T</code>. See the documentation <a href="https://godot-rust.github.io/docs/gdext/master/godot/prelude/trait.PackedSceneExt.html#method.instantiate_as">here</a>.</p>

<p>If you were productionizing this you might want to use <code class="language-plaintext highlighter-rouge">try_instantiate_as</code> which would then allow for you to either attempt to recover or gracefully exit with a helpful error message.</p>

<h6 id="set-rotation">set rotation</h6>
<p>And then you have the hardest math problem in the project. If you aren’t up on your geometry, well, you aren’t going to solve it. I view myself as a mathy kind of person. I couldn’t do this. If you know you know. If you don’t that’s what tutorials are for. To be fair. You could’ve stolen this from the <a href="https://docs.godotengine.org/en/stable/getting_started/first_2d_game/05.the_main_game_scene.html#main-script">GDScript Tutorial</a> but you would’ve needed to crack a few other tough parts to even get here.</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">let</span> <span class="k">mut</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">mob_spawn_location</span><span class="nf">.get_rotation</span><span class="p">()</span> <span class="o">+</span> <span class="n">PI</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>
        <span class="n">direction</span> <span class="o">+=</span> <span class="n">rng</span><span class="nf">.gen_range</span><span class="p">(</span><span class="o">-</span><span class="n">PI</span> <span class="o">/</span> <span class="mf">4.0</span><span class="o">..</span><span class="n">PI</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">);</span>

        <span class="n">mob_scene</span><span class="nf">.set_rotation</span><span class="p">(</span><span class="n">direction</span><span class="p">);</span>
</code></pre></div></div>

<p>Making it go is a little easier, but has a weird wrinkle</p>
<h6 id="make-the-mob-go">make the mob go</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">mob</span><span class="nf">.set_linear_velocity</span><span class="p">(</span><span class="nn">Vector2</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span><span class="nf">.rotated</span><span class="p">(</span><span class="nn">real</span><span class="p">::</span><span class="nf">from_f32</span><span class="p">(</span><span class="n">direction</span><span class="p">)));</span>
</code></pre></div></div>

<p>So you <code class="language-plaintext highlighter-rouge">set_linear_velocity()</code> with your brand new <code class="language-plaintext highlighter-rouge">Vector2</code> that you give a little rotation to. It’s not hard. I totally didn’t spend an hour trying to crack this. Nope. That didn’t happen.</p>

<p>Also you use <code class="language-plaintext highlighter-rouge">real::from_f32</code> to support double precision if you want it.</p>

<p>To cap it all off you have to add a child programatically. Which is the first and only time you do it in this project.</p>

<h6 id="add-child">add child</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">self</span><span class="py">.base</span><span class="nf">.add_child</span><span class="p">(</span><span class="n">mob_scene</span><span class="nf">.clone</span><span class="p">()</span><span class="nf">.upcast</span><span class="p">());</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">mob</span> <span class="o">=</span> <span class="n">mob_scene</span><span class="py">.cast</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Mob</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">range</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">mob</span> <span class="o">=</span> <span class="n">mob</span><span class="nf">.bind</span><span class="p">();</span>
            <span class="n">rng</span><span class="nf">.gen_range</span><span class="p">(</span><span class="n">mob</span><span class="py">.min_speed</span><span class="o">..</span><span class="n">mob</span><span class="py">.max_speed</span><span class="p">)</span>
        <span class="p">};</span>
</code></pre></div></div>

<p>Okay so the easy parts first. We call <code class="language-plaintext highlighter-rouge">self.base.add_child()</code>. It does what it says on the tin. There is a <code class="language-plaintext highlighter-rouge">.clone()</code> and <code class="language-plaintext highlighter-rouge">.upcast()</code> this is to play nice with rust’s borrowing and type semantics. If its going to leave your scope, you usually make a clone. You can do more things. <code class="language-plaintext highlighter-rouge">move</code> or the like. But <code class="language-plaintext highlighter-rouge">clone()</code> is fine. If you need even more performance then evaluate that. But for our case <code class="language-plaintext highlighter-rouge">move</code> isn’t possible because we still need that scene. We <code class="language-plaintext highlighter-rouge">.cast</code> that into <code class="language-plaintext highlighter-rouge">Mob</code> and get the <code class="language-plaintext highlighter-rouge">mut mob</code> variable.</p>

<p>This is the easy stuff. Here’s the headscratcher. You open a closure to make a local scope. We call <code class="language-plaintext highlighter-rouge">let mob = mob.bind()</code> so we’ve shadowed mob into its own thing. Then we generate a range with <code class="language-plaintext highlighter-rouge">.gen_range(...)</code>. Notice the absent semi colon. That means its return it assined to the <code class="language-plaintext highlighter-rouge">range</code> variable.</p>

<p>So we’ve created a range with extra steps? You might ask. Yes, and we’re better for it. These extra steps are allowing a borrow to occur. When you <code class="language-plaintext highlighter-rouge">bind()</code> you are getting something like a <code class="language-plaintext highlighter-rouge">RefCell</code>. This means you’ve performed a <code class="language-plaintext highlighter-rouge">borrow</code>. Which will expire at the end of the scope. But we don’t need it past this moment so we do it in a local scope so we can return the <code class="language-plaintext highlighter-rouge">borrow</code> as fast as possible. If you are still fuzzy, that’s okay. This is a lot of knitty gritty rust. Here’s some links. <a href="https://godot-rust.github.io/docs/gdext/master/godot/obj/struct.Gd.html#method.bind">bind</a>, <a href="https://doc.rust-lang.org/rust-by-example/scope/borrow.html">borrowing</a>, 
<a href="https://godot-rust.github.io/docs/gdext/master/godot/obj/struct.Gd.html#">Gd</a>
<a href="https://fongyoong.github.io/easy_rust/Chapter_42.html">refcell in easy rust</a> and <a href="https://doc.rust-lang.org/book/ch15-05-interior-mutability.html">refcell in the rust book</a></p>

<p>If you struggled to get this. Of course you did. I don’t believe anyone doing this as their first time could have arrived at this themselves. But now you know why and how to do it for the future. Lets wrap this up.</p>

<h1 id="game-over">Game Over</h1>
<p>This is using something new, but if you referenced the docs, you might have been able to get it. Its very intuitive.</p>
<h6 id="game-over-1">game over</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">#[func]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">game_over</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">score_timer</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"ScoreTimer"</span><span class="p">);</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">mob_timer</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"MobTimer"</span><span class="p">);</span>
        <span class="n">score_timer</span><span class="nf">.stop</span><span class="p">();</span>
        <span class="n">mob_timer</span><span class="nf">.stop</span><span class="p">();</span>

        <span class="k">self</span><span class="py">.base</span>
            <span class="nf">.get_tree</span><span class="p">()</span>
            <span class="nf">.unwrap</span><span class="p">()</span>
            <span class="nf">.call_group</span><span class="p">(</span><span class="s">"mobs"</span><span class="nf">.into</span><span class="p">(),</span> <span class="s">"queue_free"</span><span class="nf">.into</span><span class="p">(),</span> <span class="o">&amp;</span><span class="p">[]);</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">hud</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Hud</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"HUD"</span><span class="p">);</span>
        <span class="n">hud</span><span class="nf">.bind_mut</span><span class="p">()</span><span class="nf">.show_game_over</span><span class="p">();</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">music_player</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">AudioStreamPlayer2D</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Music"</span><span class="p">);</span>
        <span class="n">music_player</span><span class="nf">.stop</span><span class="p">();</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">death_sound</span> <span class="o">=</span> <span class="k">self</span><span class="py">.base.get_node_as</span><span class="p">::</span><span class="o">&lt;</span><span class="n">AudioStreamPlayer2D</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"DeathSound"</span><span class="p">);</span>
        <span class="n">death_sound</span><span class="nf">.play</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>You need to get the tree and then tell it to “queue_free”. This requires you to get the <code class="language-plaintext highlighter-rouge">base</code> <code class="language-plaintext highlighter-rouge">get_tree</code> on the base. That returns an optional so <code class="language-plaintext highlighter-rouge">unwrap()</code> then <code class="language-plaintext highlighter-rouge">call_group</code> to free it. The only hard part is the <code class="language-plaintext highlighter-rouge">variant</code>. If you remember from the <code class="language-plaintext highlighter-rouge">emit</code> part of this project you can make an empty variant with <code class="language-plaintext highlighter-rouge">&amp;[]</code>. We don’t need to say anything other than <code class="language-plaintext highlighter-rouge">queue_free</code>. So <code class="language-plaintext highlighter-rouge">&amp;[]</code> will get the job done.</p>

<p>You have a <code class="language-plaintext highlighter-rouge">bind_mut()</code> which you should be starting to get comfortable with. Everything else is just about what you expect.</p>

<h1 id="make-it-go">Make it go</h1>

<p>At this point you’ve now crafted everything you need to make the game happen. Follow along with <a href="https://docs.godotengine.org/en/stable/getting_started/first_2d_game/05.the_main_game_scene.html#">GDScript</a> for setting up the nodes. Don’t forget the <a href="https://docs.godotengine.org/en/stable/getting_started/first_2d_game/07.finishing-up.html">Finishing Up Sections</a> But outside of that you’ve completed it.</p>

<h1 id="next-steps">Next steps:</h1>

<p>Go check out the <a href="https://github.com/godot-rust/gdext">Gdext Github</a>. If you have any questions with Godot Rust (not this tutorial though :sweat_smile:) join us in the <a href="https://discord.com/invite/aKUCJ8rJsc">discord</a>.</p>

<p>If you notice any errors in this tutorial or anything is confusing, go to the <a href="https://github.com/0awful/literate-dodge-the-creeps-rust">tutorial github</a> and make a change to this code to correct it. I love the help. And welcome to the the wonderful world of godot rust.</p>

<h6 id="filesrclibrs">file:../src/lib.rs</h6>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">godot</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">mod</span> <span class="n">hud</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">mod</span> <span class="n">main_scene</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">mod</span> <span class="n">mob</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">mod</span> <span class="n">player</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">DodgeTheCreeps</span><span class="p">;</span>

<span class="nd">#[gdextension]</span>
<span class="k">unsafe</span> <span class="k">impl</span> <span class="n">ExtensionLibrary</span> <span class="k">for</span> <span class="n">DodgeTheCreeps</span> <span class="p">{}</span>

</code></pre></div></div>
<p>Ps. This is what <a href="https://github.com/0awful/literate-dodge-the-creeps-rust/blob/main/src/rust/src/lib.rs">lib.rs</a> should look like</p>

<p><a href="https://0awful.github.io/literate-dodge-the-creeps-rust/code-the-hud">Previous Page</a> <a href="https://github.com/0awful/literate-dodge-the-creeps-rust/blob/main/src/rust/src/main_scene.rs">Full Main Scene Code</a></p>
